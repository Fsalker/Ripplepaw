<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="bootstrap.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="vue.js"></script>
    <script src="bootstrap-vue.js"></script>
    <!--<script src="polyfill.min.js"></script>-->

    <style>
        .logo{
            transition: 0.6s;
        }

        .logo:hover{
            transform: rotate(360deg);
        }

        .lobbyCol{
            cursor: pointer;
            transition: 0.3s;
        }

        .lobbyCol:hover{
            background-color: #375a7f;
        }

        .fade-enter-active, .fade-leave-active {
            transition: opacity .5s;
        }
        .fade-enter, .fade-leave-to /* .fade-leave-active below version 2.1.8 */ {
            opacity: 0;
        }

        .joinableRoom{
            transition: 0.3s;
            cursor: pointer;
        }
        .joinableRoom:hover{
            background-color: #375a7f;
        }

        .unjoinableRoom{
            transition: 0.3s;
            cursor: not-allowed;
        }

        .unjoinableRoom:hover{
            background-color: #E74C3C;
        }

        /*table>tbody>tr:nth-child(n+2){
            transition: 0.3s;
            cursor: pointer;
        }
        table>tbody>tr:hover:nth-child(n+2){
            background-color: #375a7f;
        }*/
    </style>
</head>

<body>
    <div id="app">
        <nav class="navbar navbar-dark bg-primary">
            <a class="navbar-brand logo" href="#">Ripplepaw</a>
            <template v-if="roomId">
                <button class="btn btn-primary">
                    [#{{roomId}}] {{roomName}}
                </div>
            </template>

            <template v-if="!loggedin">
                <div class="ml-auto">
                    <button id="login_btn" class="btn btn-primary">Login</button>
                    <button id="register_btn" class="btn btn-info">Register</button>
                    <button id="register_guest_btn" class="btn btn-warning">Play as a guest</button>

                    <b-popover target="register_guest_btn" triggers="focus" placement="bottom" title="Guest mode">
                        <alert-object :data="registerGuestData"></alert-object>
                        <input id="register_guest_nick" class="form-control" placeholder="Guest Nickname" @keydown.enter="register_guest">
                        <button class="mt-2 btn btn-success" @click="register_guest">Go</button>
                    </b-popover>

                    <b-popover target="register_btn" triggers="focus" placement="bottom" title="Register">
                        <alert-object :data="registerData"></alert-object>

                        <div class="form-row mb-1">
                            <label class="col-4 col-form-label" for="register_nick">Nickname</label>
                            <input id="register_nick" type="text" class="col form-control" @keydown.enter="register">
                        </div>
                        <div class="form-row mb-1">
                            <label class="col-4 col-form-label" for="register_user">Username</label>
                            <input id="register_user" type="text" class="col form-control" @input="register_username_changed" @keydown.enter="register">
                        </div>
                        <div class="form-row">
                            <label class="col-4 col-form-label" for="register_pass">Password</label>
                            <input id="register_pass" type="password" class="col form-control" @keydown.enter="register">
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-success" @click="register">Register</button>
                        </div>
                    </b-popover>

                    <b-popover target="login_btn" triggers="focus" placement="bottom" title="Login">
                        <alert-object :data="loginData"></alert-object>
                        <div class="form-row mb-1">
                            <label class="col-4 col-form-label" for="login_user">Username</label>
                            <input id="login_user" type="text" class="col form-control" @keydown.enter="login">
                        </div>
                        <div class="form-row">
                            <label class="col-4 col-form-label" for="login_pass">Password</label>
                            <input id="login_pass" type="password" class="col form-control" @keydown.enter="login">
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-success" @click="login">Login</button>
                        </div>
                    </b-popover>
                </div>
            </template>
            <template v-else>
                <div class="ml-auto">
                    <span class="mr-1">Logged in as {{nickname}}</span>
                    <button class="btn btn-info" @click="logout" :disabled="roomId">Logout</button>
                </div>
            </template>
        </nav>

        <div class="container-fluid my-4">
            <template v-if="!roomId">
                <div>
                    <nav class="navbar navbar-dark">
                        <h1 style="display: inline-block; margin: 0">Lobbies</h1>

                        <div class="ml-auto">
                            <button class="btn btn-info" @click="getRoomList">Refresh</button>
                            <b-btn class="btn btn-info ml-1" :disabled="!loggedin" @click="changeCreatedRoomName" v-b-modal.create-lobby-modal>Create lobby</b-btn>

                            <b-modal id="create-lobby-modal" title="Lobby configuration" ok-title="Create" ok-variant="success" @ok="createRoom">
                                <alert-object :data="createRoomData"></alert-object>
                                <div class="form-row mb-1">
                                    <label class="col-3 col-form-label" for="room_name">Name</label>
                                    <input id="room_name" class="form-control col-6" @keydown.enter="createRoom" v-model="randomRoomName" maxlength="30">
                                    <button class="btn btn-info ml-1" @click="changeCreatedRoomName"><i class="fa fa-repeat"></i></button>
                                </div>
                                <div class="form-row mb-1">
                                    <label class="col-3 col-form-label" for="room_maxPlayers">Players</label>
                                    <input class="form-control col-6" id="room_maxPlayers" type="number" min="4" max="16" value="4" @keydown.enter="createRoom">
                                </div>
                                <div class="form-row mb-1">
                                    <label class="col-3 col-form-label" for="room_name">Board Width</label>
                                    <input class="form-control col-6" id="room_boardWidth" type="number" min="2" max="10" value="5" @keydown.enter="createRoom">
                                </div>
                                <div class="form-row mb-1">
                                    <label class="col-3 col-form-label" for="room_name">Board Height</label>
                                    <input class="form-control col-6" id="room_boardHeight" type="number" min="2" max="10" value="5" @keydown.enter="createRoom">
                                </div>
                                <div class="form-row mb-1">
                                    <label class="col-3 col-form-label" for="room_password">Password</label>
                                    <input class="form-control col-6" id="room_password" placeholder="Your password" @keydown.enter="createRoom">
                                </div>
                                <div class="form-row">
                                    <label class="col-3 col-form-label" for="room_name">Language</label>
                                    <select id="room_language" name="language" class="form-control col-6">
                                        <option value="english">English</option>
                                        <option value="romanian">Română</option>
                                    </select>
                                </div>
                            </b-modal>
                        </div>
                    </nav>
                </div>

                <alert-object :data="lobbyData"></alert-object>

                <template v-if="loggedin && joinedRooms && joinedRooms.length > 0">
                    <span>Currently joined lobbies:</span>
                    <button v-for="room in joinedRooms" class="btn btn-primary mr-1 mb-1" @click="displayRoom" :room-id="room.id" :room-name="room.name">
                        [#{{room.id}}] {{room.name}}
                    </button>
                </template>

                <template v-if="roomArr.length > 0">
                    <table class="table my-4" style="text-align: center">
                        <tr>
                            <th v-for="col in roomColumns" @click="sortRooms($event)" class="lobbyCol">
                                {{col}}
                            </th>
                            <!--<th width="10%">{{roomColumns[0]}}</th>
                            <th width="10%">{{roomColumns[1]}}</th>
                            <th width="40%">{{roomColumns[2]}}</th>
                            <th width="20%">{{roomColumns[3]}}</th>
                            <th width="20%">{{roomColumns[4]}}</th>
                            <th width="20%">{{roomColumns[5]}}</th>
                            <th width="20%">{{roomColumns[6]}}</th>
                            <th width="10%">{{roomColumns[7]}}</th>-->
                        </tr>
                            <tr v-for="room in roomArr" @click="joinRoom" v-bind:class="{'joinableRoom': roomIsJoinable(room), 'unjoinableRoom': !roomIsJoinable(room)}">
                                <td v-for="col of roomColumns" v-bind:style="{display: col != 1 || roomColumns[0] ? 'table-cell' : 'none'}">
                                    {{room[col]}}
                                </td>
                            </tr>
                    </table>
                </template>
                <template v-else>
                    <div style="text-align: center">
                        <p>Unfortunately, there are no open lobbies right now. Go ahead and create your own room!</p>
                    </div>
                </template>
            </template>
            <template v-else>
                <!--<h1 style="display: inline-block; margin: 0">{{roomName}}</h1>-->
                <button class="btn btn-primary" @click="closeRoom">Return to lobbies</button>

                <div class="row mt-2" style="height: 700px">
                    <div class="col-9" style="background: orangered">

                    </div>
                    <div class="col-3" style="background: gray">
                        <div style="height: 93%; background: greenyellow">
                        </div>
                        <div style="height: 7%; background: lime">
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Socket IO
        var socket;

        //
        function setAlertData(alertData, variant, text){
            alertData.text = ""
            setTimeout(() => { // Hacks! Ineffective hack for making the alerts "refreshable" lol
                alertData.variant = variant
                alertData.text = text
            }, 10)
        }

        function resetAlertData(alertData){
            alertData.variant = ""
            alertData.text = ""
        }

        function ajaxRequest(api, data, successCallback, failureCallback){
            var req = new XMLHttpRequest()
            req.open("POST", api)
            req.setRequestHeader("content-type", "application/json")
            req.send(JSON.stringify(data))
            req.onreadystatechange = () => {
                if(req.readyState == 4) {
                    if(req.status == 200) successCallback(req.response)
                    else failureCallback(req.response)
                }
            }
        }

        function loginFrontend(userId, hash, nickname, storageType = "local"){ // sets userId and sessionHash on the frontend (both in 'app' and in the cookies)
            if(storageType == "local"){
                localStorage.setItem("userId", userId)
                localStorage.setItem("sessionHash", hash)
                localStorage.setItem("nickname", nickname)
            }
            else {
                sessionStorage.setItem("userId", userId)
                sessionStorage.setItem("sessionHash", hash)
                sessionStorage.setItem("nickname", nickname)
            }
            app.userId = userId
            app.sessionHash = hash
            app.nickname = nickname
            resetAlertData(app.registerData)
            resetAlertData(app.loginData)
            resetAlertData(app.registerGuestData)
            app.getJoinedRooms()
        }

        // Vue
        Vue.component("alert-object", {
            props: ["data"],
            template: `
                    <b-alert :show="data.text!=''" :variant="data.variant">
                        {{data.text}}
                    </b-alert>
                `
        })

        var app = new Vue({
            el: "#app",
            data: {
                // Local Storage
                nickname: localStorage.getItem("nickname") || sessionStorage.getItem("nickname"),
                userId: localStorage.getItem("userId") || sessionStorage.getItem("userId"),
                sessionHash: localStorage.getItem("sessionHash") || sessionStorage.getItem("sessionHash"),

                // Configure, more or less
                roomColumns: ["Id", "Passworded", "Name", "Owner", "Players", "Board Width", "Board Height", "Language"],

                // Initialise
                roomArr: [],
                guestMode: false,
                roomId: undefined, //localStorage.getItem("roomId"),
                roomName: undefined, //localStorage.getItem("roomName"),
                randomRoomName: undefined,
                joinedRooms: undefined,
                sortedCol: undefined,

                // Game data
                role: undefined,
                expectingSocketClose: false,

                // Alert Data
                registerData: {variant: "", text: ""},
                registerGuestData: {variant: "", text: ""},
                loginData: {variant: "", text: ""},
                createRoomData: {variant: "", text: ""},
                lobbyData: {variant: "", text: ""}
            },
            mounted: function() {
                //this.changeCreatedRoomName()
                this.getRoomList()
                if(this.loggedin) {
                    this.getJoinedRooms()
                }
                //this.sortRooms("Players")
            },
            computed: {
                loggedin: function() {
                    let ans = (this.userId && this.sessionHash) ? true : false
                    return ans
                }
            },
            methods: {
                register: () => {
                    let data = {
                        nickname: document.getElementById("register_nick").value,
                        username: document.getElementById("register_user").value,
                        password: document.getElementById("register_pass").value
                    }

                    if(data.nickname.length <= 3 || data.nickname.length > 20 || data.nickname.match(/[^a-zA-Z0-9]/)) return setAlertData(app.registerData, "warning", "Nickname must contain between 4 and 20 alphanumeric characters.")
                    if(data.username.length <= 3 || data.username.length > 20 || data.username.match(/[^a-zA-Z0-9]/)) return setAlertData(app.registerData, "warning", "Username must contain between 4 and 20 alphanumeric characters.")

                    let successCallback = (data) => {data = JSON.parse(data); loginFrontend(data.userId, data.hash, data.nickname);}
                    let failureCallback = () => setAlertData(app.registerData, "danger", "Register failed.")
                    ajaxRequest("register", data, successCallback, failureCallback)
                },

                register_guest: () => {
                    let data = { nickname: document.getElementById("register_guest_nick").value }

                    if(data.nickname.length <= 3 || data.nickname.length > 20 || data.nickname.match(/[^a-zA-Z0-9]/)) return setAlertData(app.registerGuestData, "warning", "Nickname must contain between 4 and 20 alphanumeric characters.")

                    let successCallback = (data) => {
                        data = JSON.parse(data);
                        loginFrontend(data.userId, data.hash, data.nickname, "session");
                        app.guestMode = true
                    }
                    let failureCallback = () => setAlertData(app.registerGuestData, "danger", "Failed to create guest account.")
                    ajaxRequest("registerGuest", data, successCallback, failureCallback)
                },

                login: () => {
                    let data = {
                        username: document.getElementById("login_user").value,
                        password: document.getElementById("login_pass").value
                    }
                    let successCallback = (data) => {data = JSON.parse(data); loginFrontend(data.userId, data.hash, data.nickname);}
                    let failureCallback = () => setAlertData(app.loginData, "danger", "Authentification failed.")
                    ajaxRequest("login", data, successCallback, failureCallback)
                },

                register_username_changed: (event) => {
                    if(event.key == "Enter")
                        app.register()
                    else {
                        let username = document.getElementById("register_user").value
                        let successCallback = () => {
                            if(app.registerData.text == "Username is already taken.")
                                setAlertData(app.registerData, "", "")
                        }
                        let failureCallback = () => setAlertData(app.registerData, "info", "Username is already taken.")
                        ajaxRequest("usernameAvailable", {username: username}, successCallback, failureCallback)
                    }
                },

                logout: () => {
                    localStorage.removeItem("userId")
                    localStorage.removeItem("sessionHash")
                    localStorage.removeItem("nickname")
                    sessionStorage.removeItem("userId")
                    sessionStorage.removeItem("sessionHash")
                    sessionStorage.removeItem("nickname")
                    /*deleteCookie("userId")
                    deleteCookie("sessionHash")
                    deleteCookie("nickname")*/
                    app.userId = undefined
                    app.sessionHash = undefined
                    app.joinedRooms = undefined
                },

                getRoomList: () => {
                    let successCallback = (data) => {
                        data = JSON.parse(data);
                        app.roomArr = []
                        for(room of data) {
                            crtRoom = {}
                            crtRoom["Id"] = room.id
                            crtRoom["Passworded"] = room.hasPassword == "yes" ? "Yes" : "No"
                            crtRoom["Name"] = room.name
                            crtRoom["Owner"] = room.owner
                            crtRoom["Players"] = room.players+" / "+room.maxplayers
                            crtRoom["Board Width"] = room.boardWidth
                            crtRoom["Board Height"] = room.boardHeight
                            crtRoom["Language"] = room.language.charAt(0).toUpperCase() + room.language.slice(1)

                            app.roomArr.push(crtRoom)
                        }
                        app.sortedCol = undefined
                        app.sortRooms("Players")
                        app.sortRooms("Players") // Descending
                    }
                    let failureCallback = () => setAlertData(app.lobbyData, "danger", "An error has occurred when fetching the lobby lobbies.")
                    ajaxRequest("viewRooms", {}, successCallback, failureCallback)
                },

                getJoinedRooms() {
                    let data = {
                        userId: this.userId,
                        hash: this.sessionHash
                    }
                    let successCallback = (data) => {
                        data = JSON.parse(data);
                        app.joinedRooms = data
                    }
                    let failureCallback = () => {
                        setAlertData(app.lobbyData, "danger", "An error has occurred when fetching the list of joined lobbies.")
                    }
                    ajaxRequest("getJoinedRooms", data, successCallback, failureCallback)
                },

                displayRoom: async(arg, p_roomName = undefined) => { // arg = MouseEvent or roomId. if it's roomId, roomName must also be specified
                    let roomId;
                    let roomName;
                    if(typeof(arg) == "number") { // roomId and roomName are passed
                        roomId = arg
                        roomName = p_roomName
                    }
                    else { // just a mouseEvent is passed, so we have to look into roomId and roomName
                        roomId = arg.target.getAttribute("room-id")
                        roomName = arg.target.getAttribute("room-name")
                    }

                    console.log("Opening room "+roomId)
                    app.roomId = roomId
                    app.roomName = roomName
                    //localStorage.setItem("roomId", roomId)
                    //localStorage.setItem("roomName", roomName)
                    setAlertData(app.lobbyData, "", "")

                    // Open socket
                    socket = io()
                    let auth = {
                        userId: app.userId,
                        hash: app.sessionHash,
                        roomId: app.roomId
                    }

                    socket.on("connect", () => {
                        console.log("Connected!")
                        socket.emit("join room", auth)
                    })

                    socket.on("joined room", () => {
                        console.log("Joined room succesfully! Getting room data...")
                        let auth = {
                            userId: app.userId,
                            hash: app.sessionHash,
                            roomId: app.roomId
                        }
                        socket.emit("get room data", auth)
                    })

                    socket.on("received room data", (data) => {
                        console.log("Got room data succesfully!")
                        console.log(data)

                        // Now we can play!
                        socket.on("broadcasting message to room", (data) => {
                        console.log(data)
                            // Append message to chat...
                        })

                        socket.on("new words", (data) => { // Game room's words have been reset

                        })

                        socket.on("game started", (data) => { // Game has started

                        })

                        socket.on("game finished", (data) => { // Game has finished

                        })

                        socket.on("word revealed", (data) => { // A player has revealed a word

                        })
                    })

                    socket.on("disconnect", () => {
                        console.log("Got disconnected!")
                        app.roomId = undefined
                        if(app.expectingSocketClose) // This is an arbitrary socket closure
                            app.expectingSocketClose = false
                        else // We have been suddenly disconnected!
                            setAlertData(app.lobbyData, "danger", "Connection to the lobby has been lost. Please try reconnecting.")
                    })
                },

                closeRoom: (arg) => {
                    app.roomId = undefined
                    app.expectingSocketClose = true
                    //localStorage.removeItem("roomId")
                    //localStorage.removeItem("roomName")
                    app.getJoinedRooms()
                    app.getRoomList()
                    socket.close()
                },

                joinRoom: (e) => {
                    if(!app.userId) return setAlertData(app.lobbyData, "warning", "You must be logged in in order to join lobbies. Please register or play as a guest!")

                    let targetRow = e.target.parentElement

                    let playersVal = targetRow.children[app.roomColumns.indexOf("Players")].innerText
                    let players = parseInt(playersVal.split("/")[0])
                    let maxPlayers = parseInt(playersVal.split("/")[1])

                    if(players >= maxPlayers) return setAlertData(app.lobbyData, "danger", "Lobby is full!")

                    let roomId = parseInt(targetRow.children[app.roomColumns.indexOf("Id")].innerText)
                    let roomName = targetRow.children[app.roomColumns.indexOf("Name")].innerText

                    let data = {
                        userId: app.userId,
                        hash: app.sessionHash,
                        roomId: roomId
                    }
                    let successCallback = (data) => {
                        app.displayRoom(roomId, roomName)
                    }
                    let failureCallback = () => setAlertData(app.lobbyData, "danger", "An error occurred when joining the lobby.")
                    ajaxRequest("joinRoom", data, successCallback, failureCallback)

                },

                createRoom (event) {
                    event.preventDefault()
                    let data = {
                        userId: app.userId,
                        hash: app.sessionHash,
                        name: document.getElementById("room_name").value,
                        maxplayers: document.getElementById("room_maxPlayers").value,
                        boardWidth: document.getElementById("room_boardWidth").value,
                        boardHeight: document.getElementById("room_boardHeight").value,
                        password: document.getElementById("room_password").value,
                        language: document.getElementById("room_language").value
                    }

                    errorMsg = ""
                    if(data.maxplayers < 4 || data.maxplayers > 16) errorMsg = "Maximum amount of players must be between 4 and 16."
                    else if(data.boardWidth < 1 || data.boardWidth > 10) errorMsg = "Board width must be between 2 and 10."
                    else if(data.boardHeight < 1 || data.boardHeight > 10) errorMsg = "Board height must be between 2 and 10."
                    if(errorMsg) {
                        /*if(event && event.preventDefault)
                            event.preventDefault()*/

                        return setAlertData(app.createRoomData, "warning", errorMsg)
                    }

                    let successCallback = (data) => {
                        data = JSON.parse(data);
                        app.getRoomList()
                        setAlertData(app.createRoomData, "", "")
                        app.$root.$emit("bv::hide::modal", "create-lobby-modal")
                    }
                    let failureCallback = () => setAlertData(app.createRoomData, "danger", "An error has occurred when creating the lobby. Please try again.")

                    ajaxRequest("createRoom", data, successCallback, failureCallback)
                },

                generateRoomName: () => {
                    let adjectiveList = ["green", "impressive", "formidable", "nice", "pretty", "beautiful", "wonderful", "funny", "splendid", "clean", "wicked", "sly", "candid", "fluffy", "green", "fresh", "fancy", "slick", "cool", "mysterious", "challenging", "brave"]
                    let nounList = ["penguin", "coconut", "lasagna", "alcove", "island", "teapot", "donut", "rainbow", "waffle", "unicorn", "monkey", "burger", "teaspoon", "cloud", "pizza", "orange", "cucumber", "flute"]

                    adjectiveList = adjectiveList.map (word => word.charAt(0).toUpperCase() + word.slice(1))
                    nounList = nounList.map (word => word.charAt(0).toUpperCase() + word.slice(1))

                    let index_1 = Math.floor(Math.random() * adjectiveList.length)
                    let word_1 = adjectiveList[index_1]
                    adjectiveList.splice(index_1, 1)
                    let index_2 = Math.floor(Math.random() * adjectiveList.length)
                    let index_3 = Math.floor(Math.random() * nounList.length)

                    return `${word_1} ${adjectiveList[index_2]} ${nounList[index_3]}`
                },

                changeCreatedRoomName () {
                    this.randomRoomName = this.generateRoomName()
                },

                roomIsJoinable(room){
                    if(!this.loggedin) return false
                    let players = parseInt(room["Players"].split("/")[0])
                    let maxPlayers = parseInt(room["Players"].split("/")[1])
                    return players < maxPlayers
                },

                sortRooms(e){
                    let col;
                    if(e.target) // Triggered by click
                        col = e.target.innerText
                    else // Triggered by a call (arbitrary col passed)
                        col = e
                    let SECRET_PREFIX = "____"

                    if(this.sortedCol == undefined || this.sortedCol == SECRET_PREFIX + col) {
                        this.roomArr = this.roomArr.sort((a, b) => a[col].toString().localeCompare(b[col].toString()))
                        this.sortedCol = col
                    }
                    else {
                        this.sortedCol = SECRET_PREFIX + col
                        this.roomArr = this.roomArr.sort((b, a) => a[col].toString().localeCompare(b[col].toString()))
                    }
                },

                sendRoomMessage(msg){
                    data = {
                        userId: app.userId,
                        hash: app.sessionHash,
                        roomId: app.roomId,
                        msg: msg
                    }
                    socket.emit("message room", data)
                }
            }
        })
    </script>
</body>