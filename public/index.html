<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="bootstrap.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="vue.js"></script>
    <script src="bootstrap-vue.js"></script>
    <!--<script src="polyfill.min.js"></script>-->

    <style>
        .redWordBubble_dark{ /* "dark" = revealed to the spymaster, who already sees these bubbles */
            background-color: #b23529 !important;
        }
        .blueWordBubble_dark{
            background-color: #246d9e !important;
        }
        .grayWordBubble_dark{
            background-color: #777 !important;
        }
        .blackWordBubble_dark{
            border: 2px solid white;
            background-color: #000 !important;
        }
        .redWordBubble{ /* revealed word bubble colors! */
            background-color: #E74C3C !important;
        }
        .blueWordBubble{
            background-color: #3498DB !important;
        }
        .grayWordBubble{
            background-color: #AAA !important;
        }
        .blackWordBubble{
            background-color: #000 !important;
        }

        .redText{
            color: #E74C3C;
        }

        .blueText{
            color: #3498DB;
        }

        .systemMessage{
            color: #ccc;
            font-style: italic;
        }

        .chat{
            background: #666;
            border: 3px solid black;
            overflow: auto;
            word-break: break-word;
        }

        .verticalCenterHack{
            position: relative;
            top: 50%;
            transform: translateY(-50%);
        }

        .wordBubble{
            display: inline-block;
            width: 150px;
            height: 75px;
            line-height: 75px;
            background: #666;
            text-align: center;
            vertical-align: middle;
            margin: 2px;
            cursor: pointer;
            transition: 0.3s;
            overflow: hidden;
        }

        .wordBubble:hover{
            background: #888
        }

        .selectSpymaster{
            transition: 0.3s;
        }

        .selectSpymaster:hover{
            background: gold;
        }

        .selectTeam{
            transition: 0.3s;
        }

        .selectTeam:hover{
            background: #666;
            cursor:pointer;
        }

        .cannotSelectTeam{
            cursor: not-allowed;
        }

        .logo{
            transition: 0.6s;
        }

        .logo:hover{
            transform: rotate(360deg);
        }

        .lobbyCol{
            cursor: pointer;
            transition: 0.3s;
        }

        .lobbyCol:hover{
            background-color: #375a7f;
        }

        .fade-enter-active, .fade-leave-active {
            transition: opacity .5s;
        }
        .fade-enter, .fade-leave-to /* .fade-leave-active below version 2.1.8 */ {
            opacity: 0;
        }

        .joinableRoom{
            transition: 0.3s;
            cursor: pointer;
        }
        .joinableRoom:hover{
            background-color: #375a7f;
        }

        .unjoinableRoom{
            transition: 0.3s;
            cursor: not-allowed;
        }

        .unjoinableRoom:hover{
            background-color: #E74C3C;
        }

        /*table>tbody>tr:nth-child(n+2){
            transition: 0.3s;
            cursor: pointer;
        }
        table>tbody>tr:hover:nth-child(n+2){
            background-color: #375a7f;
        }*/
    </style>
</head>

<body>
    <div id="app">
        <nav class="navbar navbar-dark bg-primary">
            <a class="navbar-brand logo" href="#">Ripplepaw</a>
            <template v-if="connectedToRoom">
                <button class="btn btn-primary">[#{{roomId}}] {{roomName}}</button>
                <button class="btn btn-danger" @click="leaveLobby">Leave Lobby</button>
                <button class="ml-2 btn btn-info" @click="closeRoom">Return to Lobbies</button>
                <button class="ml-2 btn btn-success" v-if="roomData.ownerId == userId && roomData.gameStarted == 'false'" @click="startGame">Start Game</button>
            </template>

            <template v-if="!loggedin">
                <div class="ml-auto">
                    <button id="login_btn" class="btn btn-primary">Login</button>
                    <button id="register_btn" class="btn btn-info">Register</button>
                    <button id="register_guest_btn" class="btn btn-warning">Play as a guest</button>

                    <b-popover target="register_guest_btn" triggers="focus" placement="bottom" title="Guest mode">
                        <alert-object :data="registerGuestData"></alert-object>
                        <input id="register_guest_nick" class="form-control" placeholder="Guest Nickname" @keydown.enter="register_guest">
                        <button class="mt-2 btn btn-success" @click="register_guest">Go</button>
                    </b-popover>

                    <b-popover target="register_btn" triggers="focus" placement="bottom" title="Register">
                        <alert-object :data="registerData"></alert-object>

                        <div class="form-row mb-1">
                            <label class="col-4 col-form-label" for="register_nick">Nickname</label>
                            <input id="register_nick" type="text" class="col form-control" @keydown.enter="register" placeholder="Your Nickname...">
                        </div>
                        <div class="form-row mb-1">
                            <label class="col-4 col-form-label" for="register_user">Username</label>
                            <input id="register_user" type="text" class="col form-control" @input="register_username_changed" @keydown.enter="register"  placeholder="Your Username...">
                        </div>
                        <div class="form-row">
                            <label class="col-4 col-form-label" for="register_pass">Password</label>
                            <input id="register_pass" type="password" class="col form-control" @keydown.enter="register"  placeholder="Your Password...">
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-success" @click="register">Register</button>
                        </div>
                    </b-popover>

                    <b-popover target="login_btn" triggers="focus" placement="bottom" title="Login">
                        <alert-object :data="loginData"></alert-object>
                        <div class="form-row mb-1">
                            <label class="col-4 col-form-label" for="login_user">Username</label>
                            <input id="login_user" type="text" class="col form-control" @keydown.enter="login"  placeholder="Your Username...">
                        </div>
                        <div class="form-row">
                            <label class="col-4 col-form-label" for="login_pass">Password</label>
                            <input id="login_pass" type="password" class="col form-control" @keydown.enter="login"  placeholder="Your Password...">
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-success" @click="login">Login</button>
                        </div>
                    </b-popover>
                </div>
            </template>
            <template v-else>
                <div class="ml-auto">
                    <span class="mr-1">Logged in as {{nickname}}</span>
                    <button class="btn btn-info" @click="logout" :disabled="roomId">Logout</button>
                </div>
            </template>
        </nav>

        <div class="container-fluid my-2">
            <template v-if="!connectedToRoom">
                <div>
                    <nav class="navbar navbar-dark">
                        <h1 style="display: inline-block; margin: 0">Lobbies</h1>

                        <div class="ml-auto">
                            <input id="password" placeholder="Joined lobby password..." class="form-control" style="width: 196px; display: inline-block; padding-top: 2px;">
                            <button class="btn btn-info" @click="getRoomList">Refresh</button>
                            <b-btn class="btn btn-info ml-1" :disabled="!loggedin" @click="changeCreatedRoomName" v-b-modal.create-lobby-modal>Create lobby</b-btn>

                            <b-modal id="create-lobby-modal" title="Lobby configuration" ok-title="Create" ok-variant="success" @ok="createRoom">
                                <alert-object :data="createRoomData"></alert-object>
                                <div class="form-row mb-1">
                                    <label class="col-3 col-form-label" for="room_name">Name</label>
                                    <input id="room_name" class="form-control col-6" @keydown.enter="createRoom" v-model="randomRoomName" maxlength="30">
                                    <button class="btn btn-info ml-1" @click="changeCreatedRoomName"><i class="fa fa-repeat"></i></button>
                                </div>
                                <div class="form-row mb-1">
                                    <label class="col-3 col-form-label" for="room_maxPlayers">Players</label>
                                    <input class="form-control col-6" id="room_maxPlayers" type="number" min="4" max="16" value="4" @keydown.enter="createRoom">
                                </div>
                                <div class="form-row mb-1">
                                    <label class="col-3 col-form-label" for="room_name">Board Width</label>
                                    <input class="form-control col-6" id="room_boardWidth" type="number" min="2" max="10" value="5" @keydown.enter="createRoom">
                                </div>
                                <div class="form-row mb-1">
                                    <label class="col-3 col-form-label" for="room_name">Board Height</label>
                                    <input class="form-control col-6" id="room_boardHeight" type="number" min="2" max="10" value="5" @keydown.enter="createRoom">
                                </div>
                                <div class="form-row mb-1">
                                    <label class="col-3 col-form-label" for="room_password">Password</label>
                                    <input class="form-control col-6" id="room_password" placeholder="Your password" @keydown.enter="createRoom">
                                </div>
                                <div class="form-row">
                                    <label class="col-3 col-form-label" for="room_name">Language</label>
                                    <select id="room_language" name="language" class="form-control col-6">
                                        <option value="english">English</option>
                                        <option value="romanian">Română</option>
                                    </select>
                                </div>
                            </b-modal>
                        </div>
                    </nav>
                </div>

                <alert-object :data="lobbyData"></alert-object>

                <template v-if="loggedin && joinedRooms && joinedRooms.length > 0">
                    <span>Currently joined lobbies:</span>
                    <button v-for="room in joinedRooms" class="btn btn-primary mr-1 mb-1" @click="displayRoom" :room-id="room.id" :room-name="room.name">
                        [#{{room.id}}] {{room.name}}
                    </button>
                </template>

                <template v-if="roomArr.length > 0">
                    <table class="table my-4" style="text-align: center">
                        <tr>
                            <th v-for="col in roomColumns" @click="sortRooms($event)" class="lobbyCol">
                                {{col}}
                            </th>
                        </tr>
                            <tr v-for="room in roomArr" @click="joinRoom" v-bind:class="{'joinableRoom': roomIsJoinable(room), 'unjoinableRoom': !roomIsJoinable(room)}">
                                <td v-for="col of roomColumns" v-bind:style="{display: col != 1 || roomColumns[0] ? 'table-cell' : 'none'}">
                                    {{room[col]}}
                                </td>
                            </tr>
                    </table>
                </template>
                <template v-else>
                    <div style="text-align: center">
                        <p>There are no open lobbies right now. Go ahead and create your own room!</p>
                    </div>
                </template>
            </template>
            <template v-else>
                <!--<h1 style="display: inline-block; margin: 0">{{roomName}}</h1>-->

                <alert-object :data="insideLobbyData"></alert-object>

                <div class="mx-4 mt-0">
                    <div class="row m-0 my-2">
                        <div class="col-lg-8 col-12 mt-3" style="text-align: center">
                            <h3 v-if="roomData.winningTeam">
                                The game is over! Winning team: <span :class="{redText: roomData.winningTeam == 'red', blueText: roomData.winningTeam == 'blue'}">{{roomData.winningTeam.charAt(0).toUpperCase() + roomData.winningTeam.slice(1)}} Team</span>
                            </h3>
                            <template v-else-if="roomData.teamColorTurn">
                                <template v-if="!itsMyTurn">
                                    <h4 v-if="roomData.teamRoleTurn == 'spymaster'"><span :class="{redText: roomData.teamColorTurn == 'red', blueText: roomData.teamColorTurn == 'blue'}">{{roomData.teamColorTurn.charAt(0).toUpperCase() + roomData.teamColorTurn.slice(1)}} {{roomData.teamRoleTurn.charAt(0).toUpperCase() + roomData.teamRoleTurn.slice(1)}}</span> is taking their turn.</h4>
                                    <h4 v-else><span :class="{redText: roomData.teamColorTurn == 'red', blueText: roomData.teamColorTurn == 'blue'}">{{roomData.teamColorTurn.charAt(0).toUpperCase() + roomData.teamColorTurn.slice(1)}} {{roomData.teamRoleTurn.charAt(0).toUpperCase() + roomData.teamRoleTurn.slice(1)}}s</span> are guessing their words! They have {{roomData.teamGuessesLeft}} guesses left.</h4>
                                </template>
                                <template v-else>
                                    <h4>It's your turn!</h4>
                                    <template v-if="myRole == 'spymaster'">
                                        <p>Give your team a hint and a number of words they may guess. Remember, your hint must contain a single word!</p>
                                        <div class="mb-3 ml-4" style="text-align: middle">
                                            Maximum number of guesses: <input v-model="hintNumGuesses" id="hint_num_guesses" style="display: inline-block; width: 60px" class="form-control mb-1" type="number" min="1" :max="roomData.boardHeight * roomData.boardWidth" placeholder="..."><br>
                                            <div>
                                                Word (hint):
                                                <input @keydown.enter="sendHint"  v-model="hintWord" id="hint_word" style="display: inline-block; width: 200px; padding-top: 2px" class="form-control ml-1" placeholder="Your hint...">
                                                <button class="btn btn-success" @click="sendHint" :disabled="!hintWord || !hintNumGuesses">Send Hint!</button>
                                            </div>
                                        </div>
                                    </template>
                                    <template v-else>
                                        <p class="mb-2">Guess your <span :class="{redText: myTeam == 'red', blueText: myTeam == 'blue'}">team's</span> words or end the turn. The hint is: {{roomData.hintWord}}</p>
                                        <p class="mb-2">You have {{roomData.teamGuessesLeft}} guesses left.</p>
                                        <button class="btn btn-success mb-2" @click="endTurn">End Turn</button>
                                    </template>
                                </template>
                            </template>
                            <div v-for="row in roomData.boardHeight">
                                <span :class="getAdditionalWordBubbleClass(row, col)" @click="sendGuess" class="wordBubble" :id="`word ${row} ${col}`" :word-row="row" :word-col="col" v-for="col in roomData.boardWidth">
                                    {{getRoomWordInMatrix(row, col)}}
                                </span>
                            </div>
                        </div>
                        <div class="col-lg-4 col-12 mt-2">
                            <ul id="roomChatroom" class="chat p-2 mb-2" style="list-style: none; padding: 0; height: 300px">
                                <li class="systemMessage">This is the chatroom. Your messages and the other players' messages will be displayed here!</li>
                            </ul>
                            <input id="roomMsg" class="form-control mb-2" type="text" @keydown.enter="sendRoomMessage" placeholder="Type a message and press Enter...">
                        </div>
                    </div>

                    <div class="mb-4" style="background: #444; font-weight: bold; font-size: 20px;">
                        <div class="px-2" :class="roomData.gameStarted == 'false' ? 'selectTeam' : ''" style="color: red" @click="roomData.gameStarted == 'false' ? changeRole('red player') : ''">
                            Red Players -
                            <span style="color: white" v-for="nickname in roomRedPlayers">{{nickname}}</span>
                        </div>
                        <div class="px-2" :class="roomData.gameStarted == 'false' ? 'selectTeam' : ''" style="color: red" @click="roomData.gameStarted == 'false' ? changeRole('red spymaster') : ''">
                            Red Spymaster:
                            <span style="color: white">{{redSpymaster}}</span>
                        </div>
                        <div class="px-2" :class="roomData.gameStarted == 'false' ? 'selectTeam' : ''" style="color: deepskyblue" @click="roomData.gameStarted == 'false' ? changeRole('blue player') : ''">
                            Blue Players -
                            <span style="color: white" v-for="nickname in roomBluePlayers">{{nickname}}</span>
                        </div>
                        <div class="px-2" :class="roomData.gameStarted == 'false' ? 'selectTeam' : ''" style="color: deepskyblue" @click="roomData.gameStarted == 'false' ? changeRole('blue spymaster') : ''">
                            Blue Spymaster:
                            <span style="color: white">{{blueSpymaster}}</span>
                        </div>
                        <div class="px-2" :class="roomData.gameStarted == 'false' ? 'selectTeam' : ''" style="color: #CCC" @click="roomData.gameStarted == 'false' ? changeRole('spectator') : ''">
                            Spectators -
                            <span style="color: white" v-for="nickname in roomSpectators">{{nickname}}</span>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Configs
        const SYSTEM_USER = "(system)"

        // Socket IO
        var socket;

        //
        function setAlertData(alertData, variant, text){
            /*let d = new Date()
            let hours = d.getHours()
            let minutes = d.getMinutes()
            let seconds = d.getSeconds()
            if(hours <= 9) hours = "0" + hours
            if(minutes <= 9) minutes  = "0" + minutes
            if(seconds <= 9) seconds  = "0" + seconds
            alertData.text = `[${hours}:${minutes}:${seconds}] `*/
            alertData.text = ''
            setTimeout(() => { // [fixme] Hacks! Ineffective hack for making the alerts "refreshable" lol
                alertData.variant = variant
                alertData.text += text
            }, 10)
        }

        function resetAlertData(alertData){
            alertData.variant = ""
            alertData.text = ""
        }

        function ajaxRequest(api, data, successCallback, failureCallback){
            var req = new XMLHttpRequest()
            req.open("POST", api)
            req.setRequestHeader("content-type", "application/json")
            req.send(JSON.stringify(data))
            req.onreadystatechange = () => {
                if(req.readyState == 4) {
                    if(req.status == 200) successCallback(req.response)
                    else failureCallback(req.response)
                }
            }
        }

        function loginFrontend(userId, hash, nickname, storageType = "local"){ // sets userId and sessionHash on the frontend (both in 'app' and in the cookies)
            if(storageType == "local"){
                localStorage.setItem("userId", userId)
                localStorage.setItem("sessionHash", hash)
                localStorage.setItem("nickname", nickname)
            }
            else {
                sessionStorage.setItem("userId", userId)
                sessionStorage.setItem("sessionHash", hash)
                sessionStorage.setItem("nickname", nickname)
            }
            app.userId = userId
            app.sessionHash = hash
            app.nickname = nickname
            resetAlertData(app.registerData)
            resetAlertData(app.loginData)
            resetAlertData(app.registerGuestData)
            app.getJoinedRooms()
        }

        function addMessageToLobbyChat(authorNickname, msg){
            let chat = document.getElementById("roomChatroom")
            let isScrolledToBottom = chat.scrollHeight - chat.clientHeight <= chat.scrollTop + 1;
            let liElement = document.createElement("LI")
            //liElement.text = msg
            let liText = document.createTextNode(msg)
            if(authorNickname == SYSTEM_USER)
                liElement.classList.add("systemMessage")
                //chat.innerHTML += `<li class="systemMessage">${msg}</li>`
            else{
                let authorElement = document.createElement("B")
                authorElement.appendChild(document.createTextNode(authorNickname+": "))
                liElement.appendChild(authorElement)
            }
                //chat.innerHTML += `<li><b>${authorNickname}:</b> ${msg}</li>`
            liElement.appendChild(liText)
            chat.appendChild(liElement)
            if(isScrolledToBottom) // If we're already scrolled at the bottom, automatically scroll down again! Clever.
                chat.scrollTop = chat.scrollHeight - chat.clientHeight
        }

        // Vue
        Vue.component("alert-object", {
            props: ["data"],
            template: `
                    <b-alert :show="data.text!=''" :variant="data.variant">
                        {{data.text}}
                    </b-alert>
                `
        })

        var app = new Vue({
            el: "#app",
            data: {
                // Local Storage
                nickname: localStorage.getItem("nickname") || sessionStorage.getItem("nickname"),
                userId: localStorage.getItem("userId") || sessionStorage.getItem("userId"),
                sessionHash: localStorage.getItem("sessionHash") || sessionStorage.getItem("sessionHash"),

                // Configure, more or less
                roomColumns: ["Id", "Passworded", "Name", "Owner", "Players", "Board Width", "Board Height", "Language"],

                // Initialise
                roomArr: [],
                guestMode: false,
                roomId: undefined, //localStorage.getItem("roomId"),
                roomName: undefined, //localStorage.getItem("roomName"),
                randomRoomName: undefined,
                joinedRooms: undefined,
                sortedCol: undefined,
                connectedToRoom: false,

                // Game data
                expectingSocketClose: false,
                roomData: undefined,
                hintWord: undefined,
                hintNumGuesses: undefined,
                winningTeam: undefined,

                // Alert Data
                registerData: {variant: "", text: ""},
                registerGuestData: {variant: "", text: ""},
                loginData: {variant: "", text: ""},
                createRoomData: {variant: "", text: ""},
                lobbyData: {variant: "", text: ""},
                insideLobbyData: {variant: "", text: ""},
            },
            mounted: function() {
                //this.changeCreatedRoomName()
                this.getRoomList()
                if(this.loggedin) {
                    this.getJoinedRooms()
                }
                //this.sortRooms("Players")
            },
            computed: {
                loggedin: function() {
                    let ans = (this.userId && this.sessionHash) ? true : false
                    return ans
                },

                getAdditionalWordBubbleClass: function(row, col){
                    console.log(`${row} ${col}`)
                },

                myTeam: function() {
                    if(this.roomData){
                        let myUser = this.roomData.users.filter(user => user.id == this.userId)
                        if(myUser.length > 0)
                            return myUser[0].role.split(" ")[0]
                    }

                    return undefined
                },

                myRole: function() {
                    if(this.roomData){
                        let myUser = this.roomData.users.filter(user => user.id == this.userId)
                        if(myUser.length > 0)
                            return myUser[0].role.split(" ")[1]
                    }

                    return undefined
                },

                itsMyTurn: function(){
                    return this.myRole == this.roomData.teamRoleTurn && this.myTeam == this.roomData.teamColorTurn
                },

                redSpymaster: function() {
                    return this.getRoomNicknamesByRole("red spymaster")
                },

                blueSpymaster: function() {
                    return this.getRoomNicknamesByRole("blue spymaster")
                },

                roomRedPlayers: function() {
                    return this.getRoomNicknamesByRole("red player")
                },

                roomBluePlayers: function() {
                    return this.getRoomNicknamesByRole("blue player")
                },

                roomSpectators: function() {
                    return this.getRoomNicknamesByRole("spectator")
                },
            },
            methods: {
                register: () => {
                    let data = {
                        nickname: document.getElementById("register_nick").value,
                        username: document.getElementById("register_user").value,
                        password: document.getElementById("register_pass").value
                    }

                    if(data.nickname.length <= 3 || data.nickname.length > 20 || data.nickname.match(/[^a-zA-Z0-9]/)) return setAlertData(app.registerData, "warning", "Nickname must contain between 4 and 20 alphanumeric characters.")
                    if(data.username.length <= 3 || data.username.length > 20 || data.username.match(/[^a-zA-Z0-9]/)) return setAlertData(app.registerData, "warning", "Username must contain between 4 and 20 alphanumeric characters.")

                    let successCallback = (data) => {data = JSON.parse(data); loginFrontend(data.userId, data.hash, data.nickname);}
                    let failureCallback = () => setAlertData(app.registerData, "danger", "Register failed.")
                    ajaxRequest("register", data, successCallback, failureCallback)
                },

                register_guest: () => {
                    let data = { nickname: document.getElementById("register_guest_nick").value }

                    if(data.nickname.length <= 3 || data.nickname.length > 20 || data.nickname.match(/[^a-zA-Z0-9]/)) return setAlertData(app.registerGuestData, "warning", "Nickname must contain between 4 and 20 alphanumeric characters.")

                    let successCallback = (data) => {
                        data = JSON.parse(data);
                        loginFrontend(data.userId, data.hash, data.nickname, "session");
                        app.guestMode = true
                    }
                    let failureCallback = () => setAlertData(app.registerGuestData, "danger", "Failed to create guest account.")
                    ajaxRequest("registerGuest", data, successCallback, failureCallback)
                },

                login: () => {
                    let data = {
                        username: document.getElementById("login_user").value,
                        password: document.getElementById("login_pass").value
                    }
                    let successCallback = (data) => {data = JSON.parse(data); loginFrontend(data.userId, data.hash, data.nickname);}
                    let failureCallback = () => setAlertData(app.loginData, "danger", "Authentification failed.")
                    ajaxRequest("login", data, successCallback, failureCallback)
                },

                register_username_changed: (event) => {
                    if(event.key == "Enter")
                        app.register()
                    else {
                        let username = document.getElementById("register_user").value
                        let successCallback = () => {
                            if(app.registerData.text == "Username is already taken.")
                                setAlertData(app.registerData, "", "")
                        }
                        let failureCallback = () => setAlertData(app.registerData, "info", "Username is already taken.")
                        ajaxRequest("usernameAvailable", {username: username}, successCallback, failureCallback)
                    }
                },

                logout: () => {
                    localStorage.removeItem("userId")
                    localStorage.removeItem("sessionHash")
                    localStorage.removeItem("nickname")
                    sessionStorage.removeItem("userId")
                    sessionStorage.removeItem("sessionHash")
                    sessionStorage.removeItem("nickname")
                    /*deleteCookie("userId")
                    deleteCookie("sessionHash")
                    deleteCookie("nickname")*/
                    app.userId = undefined
                    app.sessionHash = undefined
                    app.joinedRooms = undefined
                },

                getRoomList: () => {
                    let successCallback = (data) => {
                        data = JSON.parse(data);
                        app.roomArr = []
                        for(room of data) {
                            crtRoom = {}
                            crtRoom["Id"] = room.id
                            crtRoom["Passworded"] = room.hasPassword == "yes" ? "Yes" : "No"
                            crtRoom["Name"] = room.name
                            crtRoom["Owner"] = room.owner
                            crtRoom["Players"] = room.players+" / "+room.maxplayers
                            crtRoom["Board Width"] = room.boardWidth
                            crtRoom["Board Height"] = room.boardHeight
                            crtRoom["Language"] = room.language.charAt(0).toUpperCase() + room.language.slice(1)

                            app.roomArr.push(crtRoom)
                        }
                        app.sortedCol = undefined
                        app.sortRoomsDescending("Id")
                    }
                    let failureCallback = () => setAlertData(app.lobbyData, "danger", "An error has occurred when fetching the lobby lobbies.")
                    ajaxRequest("viewRooms", {}, successCallback, failureCallback)
                },

                getJoinedRooms() {
                    let data = {
                        userId: this.userId,
                        hash: this.sessionHash
                    }
                    let successCallback = (data) => {
                        data = JSON.parse(data);
                        app.joinedRooms = data
                    }
                    let failureCallback = () => {
                        setAlertData(app.lobbyData, "danger", "An error has occurred when fetching the list of joined lobbies.")
                    }
                    ajaxRequest("getJoinedRooms", data, successCallback, failureCallback)
                },

                displayRoom: async(arg, p_roomName = undefined) => { // arg = MouseEvent or roomId. if it's roomId, roomName must also be specified
                    let roomId;
                    let roomName;
                    if(typeof(arg) == "number") { // roomId and roomName are passed
                        roomId = arg
                        roomName = p_roomName
                    }
                    else { // just a mouseEvent is passed, so we have to look into roomId and roomName
                        roomId = arg.target.getAttribute("room-id")
                        roomName = arg.target.getAttribute("room-name")
                    }

                    app.roomId = roomId
                    app.roomName = roomName
                    //localStorage.setItem("roomId", roomId)
                    //localStorage.setItem("roomName", roomName)
                    setAlertData(app.lobbyData, "", "")

                    // Open socket
                    socket = io()
                    let auth = {
                        userId: app.userId,
                        hash: app.sessionHash,
                        roomId: app.roomId
                    }

                    socket.on("connect", () => {
                        console.log("Connected!")
                        socket.emit("join room", auth)
                    })

                    socket.on("joined room", () => {
                        console.log("Joined room succesfully! Getting room data...")
                        let auth = {
                            userId: app.userId,
                            hash: app.sessionHash,
                            roomId: app.roomId
                        }
                        socket.emit("get room data", auth)
                    })

                    socket.on("received spymaster words", (data) => {
                        console.log("Received spymaster words...")
                        app.roomData.words = data.words
                    })

                    socket.on("received room data", (data) => {
                        console.log("Got room data succesfully!")
                        app.roomData = data

                        /*app.roomData.words.forEach( (val, index) => {
                            let col = index % app.roomData.boardWidth
                            let row = parseInt(index / app.roomData.boardWidth)
                            let word_html_id = `word ${row} ${col}`
                            let word_html_elem = document.getElementById(word_html_id)
                            //console.log(app.roomData.boardWidth)
                            //console.log(row)
                            //console.log(col)
                            console.log(word_html_id)
                            console.log(document.getElementById(word_html_id))
                        })
                        console.log("---")
                        console.log(document.getElementById("word 4 4"))*/

                        // Now we can play!
                        app.connectedToRoom = true

                        socket.on("broadcasting message to room", (data) => {
                            /*let li_node = document.createElement("li");
                            let text_node = document.createTextNode(`${data.userNickname}: ${data.msg}`)
                            li_node.appendChild(text_node)
                            document.getElementById("roomChatroom").appendChild(li_node)*/

                            addMessageToLobbyChat(data.userNickname, data.msg)
                        })

                        socket.on("users updated", (data) => { // Users update - someone joins, leaves, changes their role etc
                            if(app.roomData.ownerId != data.roomOwnerId)
                                addMessageToLobbyChat(SYSTEM_USER, "Lobby owner has been changed.")
                            app.roomData.ownerId = data.roomOwnerId
                            let newUsers = data.users
                            let oldUsers = app.roomData.users
                            app.roomData.users = newUsers
                            //addMessageToLobbyChat(SYSTEM_USER, "Someone has changed their role!")
                            //addMessageToLobbyChat(SYSTEM_USER, "Users have been updated!")
                        })

                        socket.on("started game", (data) => { // Game room's words have been reset
                            app.roomData.teamColorTurn = data.teamColorTurn
                            app.roomData.teamRoleTurn = "spymaster"
                            app.roomData.gameStarted = true
                            console.log("Game started! Starting team: "+app.roomData.teamColorTurn)
                            if(app.myRole == "spymaster") {
                                let data = {
                                    userId: app.userId,
                                    hash: app.sessionHash,
                                    roomId: roomId
                                }
                                console.log("Asking for spymaster words...")
                                socket.emit("receive spymaster words", data)
                            }
                        })

                        socket.on("received hint", (data) => {
                            console.log(data)
                            app.hintWord = undefined
                            app.hintNumGuesses = undefined
                            app.roomData.teamGuessesLeft = data.maxGuesses
                            app.roomData.hintWord = data.hint
                            app.roomData.teamRoleTurn = "player"
                        })

                        socket.on("received guess", (data) => { // data.wordId, data.color
                            console.log()
                            let oldWord = app.roomData.words.filter(word => word.id == data.wordId)
                            oldWord[0].revealed = "true"
                            oldWord[0].color = data.color
                            --app.roomData.teamGuessesLeft
                        })

                        socket.on("game over", (data) => { // Game has finished
                            console.log("Game is over! Winning team: "+data.winningTeam)
                            console.log(data)
                            console.log(app)
                            console.log(app.roomData)
                            app.roomData.gameStarted = 'false'
                            app.roomData.winningTeam = data.winningTeam
                        })

                        socket.on("other team plays now", (data) => { // Player has passed their team's turn OR they have depleted their amount of guesses
                            console.log("The other team plays now...")
                            app.roomData.teamRoleTurn = "spymaster"
                            app.roomData.teamColorTurn = data.otherTeamColor
                        })

                        socket.on("word revealed", (data) => { // A player has revealed a word

                        })
                    })

                    socket.on("disconnect", () => {
                        console.log("Got disconnected!")
                        app.connectedToRoom = false
                        app.roomId = undefined
                        if(app.expectingSocketClose) // This is an arbitrary socket closure
                            app.expectingSocketClose = false
                        else { // We have been suddenly disconnected!
                            app.getJoinedRooms()
                            app.getRoomList()
                            setAlertData(app.lobbyData, "danger", "Connection to the lobby has been lost. Please try reconnecting.")
                        }
                        socket.close()
                    })
                },

                closeRoom: (arg) => {
                    app.roomId = undefined
                    app.roomData = undefined
                    app.expectingSocketClose = true
                    resetAlertData(app.insideLobbyData)
                    //localStorage.removeItem("roomId")
                    //localStorage.removeItem("roomName")
                    app.getJoinedRooms()
                    app.getRoomList()
                    socket.close()
                },

                joinRoom: (e, p_roomName = undefined) => { // e = MouseEvent or roomId. If it's the room's id, then roomName must also be specified
                    if(!app.userId) return setAlertData(app.lobbyData, "warning", "You must be logged in in order to join lobbies. Please register or play as a guest!")

                    let roomId, roomName;
                    if(e.target) { // MouseEvent - clicked on the lobby's row
                        let targetRow = e.target.parentElement

                        roomId = parseInt(targetRow.children[app.roomColumns.indexOf("Id")].innerText)
                        roomName = targetRow.children[app.roomColumns.indexOf("Name")].innerText

                        if(app.joinedRooms.filter(room => room.id == roomId).length > 0) // Room already joined
                            return app.displayRoom(roomId, roomName)

                        let playersVal = targetRow.children[app.roomColumns.indexOf("Players")].innerText
                        let players = parseInt(playersVal.split("/")[0])
                        let maxPlayers = parseInt(playersVal.split("/")[1])

                        if(players >= maxPlayers) return setAlertData(app.lobbyData, "danger", "Lobby is full!")
                    } else {
                        roomId = e
                        roomName = p_roomName
                    }

                    let data = {
                        userId: app.userId,
                        hash: app.sessionHash,
                        roomId: roomId,
                        password: document.getElementById("password").value
                    }
                    let successCallback = (data) => {
                        app.displayRoom(roomId, roomName)
                    }
                    let failureCallback = (data) => {
                        console.log(data)
                        if(data == "banned")
                            setAlertData(app.lobbyData, "danger", "You have been banned from joining this lobby.")
                        else if(data == "bad password")
                            setAlertData(app.lobbyData, "danger", "Password is incorrect.")
                        else
                            setAlertData(app.lobbyData, "danger", "An error occurred when joining the lobby.")
                    }
                    ajaxRequest("joinRoom", data, successCallback, failureCallback)

                },

                createRoom (event) {
                    event.preventDefault()
                    let data = {
                        userId: app.userId,
                        hash: app.sessionHash,
                        name: document.getElementById("room_name").value,
                        maxplayers: document.getElementById("room_maxPlayers").value,
                        boardWidth: document.getElementById("room_boardWidth").value,
                        boardHeight: document.getElementById("room_boardHeight").value,
                        password: document.getElementById("room_password").value,
                        language: document.getElementById("room_language").value
                    }

                    errorMsg = ""
                    if(data.maxplayers < 4 || data.maxplayers > 16) errorMsg = "Maximum amount of players must be between 4 and 16."
                    else if(data.boardWidth < 1 || data.boardWidth > 10) errorMsg = "Board width must be between 2 and 10."
                    else if(data.boardHeight < 1 || data.boardHeight > 10) errorMsg = "Board height must be between 2 and 10."
                    if(errorMsg) {
                        /*if(event && event.preventDefault)
                            event.preventDefault()*/

                        return setAlertData(app.createRoomData, "warning", errorMsg)
                    }

                    let successCallback = (received_data) => { // data.roomId
                        received_data = JSON.parse(received_data);
                        //app.getRoomList()
                        setAlertData(app.createRoomData, "", "")
                        app.$emit("bv::hide::modal", "create-lobby-modal")

                        let roomId = received_data.roomId
                        let roomName = data.name
                        app.joinRoom(roomId, roomName)
                    }
                    let failureCallback = () => setAlertData(app.createRoomData, "danger", "An error has occurred when creating the lobby. Please try again.")

                    ajaxRequest("createRoom", data, successCallback, failureCallback)
                },

                generateRoomName: () => {
                    let adjectiveList = ["green", "impressive", "formidable", "nice", "pretty", "beautiful", "wonderful", "funny", "splendid", "clean", "wicked", "sly", "candid", "fluffy", "green", "fresh", "fancy", "slick", "cool", "mysterious", "challenging", "brave"]
                    let nounList = ["penguin", "coconut", "lasagna", "alcove", "island", "teapot", "donut", "rainbow", "waffle", "unicorn", "monkey", "burger", "teaspoon", "cloud", "pizza", "orange", "cucumber", "flute"]

                    adjectiveList = adjectiveList.map (word => word.charAt(0).toUpperCase() + word.slice(1))
                    nounList = nounList.map (word => word.charAt(0).toUpperCase() + word.slice(1))

                    let index_1 = Math.floor(Math.random() * adjectiveList.length)
                    let word_1 = adjectiveList[index_1]
                    adjectiveList.splice(index_1, 1)
                    let index_2 = Math.floor(Math.random() * adjectiveList.length)
                    let index_3 = Math.floor(Math.random() * nounList.length)

                    return `${word_1} ${adjectiveList[index_2]} ${nounList[index_3]}`
                },

                changeCreatedRoomName () {
                    this.randomRoomName = this.generateRoomName()
                },

                roomIsJoinable(room){
                    if(!this.loggedin) return false
                    let roomId = parseInt(room["Id"])
                    if(app.joinedRooms && app.joinedRooms.filter(room => room.id == roomId).length > 0) // Room already joined
                        return true;
                    let players = parseInt(room["Players"].split("/")[0])
                    let maxPlayers = parseInt(room["Players"].split("/")[1])
                    return players < maxPlayers
                },

                sortRoomsDescending(e){
                    sortRooms(e);
                    sortRooms(e)
                },

                sortRooms(e){
                    let col;
                    if(e.target) // Triggered by click
                        col = e.target.innerText
                    else // Triggered by a call (arbitrary col passed)
                        col = e
                    let SECRET_PREFIX = "____"

                    function sortArr(arr, col, inverse = false){
                        return arr.sort((a, b) => {
                            if(inverse) [a, b] = [b, a]
                            if(typeof(a[col]) == "number" && typeof(b[col]) == "number"){
                                /*console.log("Comparing numbers")
                                console.log(a)
                                console.log(b)*/
                                if(a[col]<b[col]) return -1;
                                else if(a[col]==b[col]) return 0;
                                else return 1;
                            }
                            else if(typeof(a[col]) == "string" && typeof(b[col]) == "string"){
                                //console.log("Comparing strings")
                                return a[col].localeCompare(b[col])
                            }
                            else {
                                //console.log("Comparing... something")
                                return a[col].toString().localeCompare(b[col].toString())
                            }
                        })
                    }

                    if(this.sortedCol == undefined || this.sortedCol == SECRET_PREFIX + col) {
                        this.roomArr = sortArr(this.roomArr, col)
                        this.sortedCol = col
                    }
                    else {
                        this.sortedCol = SECRET_PREFIX + col
                        this.roomArr = this.roomArr = sortArr(this.roomArr, col, true)
                    }
                },

                sendRoomMessage(){
                    data = {
                        userId: app.userId,
                        hash: app.sessionHash,
                        roomId: app.roomId,
                        msg: document.getElementById("roomMsg").value
                    }
                    document.getElementById("roomMsg").value = ""

                    if(data.msg) // Don't send "" messages (empty messages)
                        socket.emit("message room", data)
                },

                changeRole(newRole){ // newRole = red / blue / spectator / red spymaster / blue spymaster
                    let data = {
                        userId: app.userId,
                        hash: app.sessionHash,
                        roomId: app.roomId,
                        role: newRole
                    }

                    socket.emit("change role", data)
                },

                getRoomNicknamesByRole(role){
                    if(this.roomData == undefined) return ""

                    ans = []
                    for(user of app.roomData.users) {
                        let nick = user.nickname
                        if(user.id == app.roomData.ownerId)
                            nick = `${nick} (lobby owner)`
                        if (user.role == role)
                            ans.push(nick)
                    }

                    ansStr = ans.join(", ")

                    //if(role.indexOf("spymaster") != -1) // Looking for the spymaster
                    if(ansStr.length == 0)
                        ansStr = "..." // Inform the players that the spot is open!

                    //console.log(role+"||||"+ansStr)
                    return ansStr
                },

                getRoomWordInMatrix(row, col){
                    let index = (row-1) * this.roomData.boardWidth + col-1
                    let word = this.roomData.words[index].word
                    //word = word.toUpperCase()
                    word = word[0].toUpperCase() + word.slice(1).toLowerCase()
                    return word
                },

                leaveLobby(){
                    let data = {
                        userId: this.userId,
                        hash: this.sessionHash,
                        roomId: this.roomId
                    }

                    let successCallback = () => {
                        this.closeRoom()
                    }
                    let failureCallback = () => console.log("An error has occurred when leaving the lobby.")
                    ajaxRequest("leaveRoom", data, successCallback, failureCallback)
                },

                startGame(){ // socket is connected
                    let data = {
                        userId: this.userId,
                        hash: this.sessionHash,
                        roomId: this.roomId
                    }

                    // [Debug] Uncomment this for release
                    if(app.roomRedPlayers == "...") return setAlertData(this.insideLobbyData, "warning", "There must be at least a Red Player before starting the game!")
                    if(app.redSpymaster == "...") return setAlertData(this.insideLobbyData, "warning", "There must be a Red Spymaster before starting the game!")
                    if(app.roomBluePlayers == "...") return setAlertData(this.insideLobbyData, "warning", "There must be at least a Blue Player before starting the game!")
                    if(app.blueSpymaster == "...") return setAlertData(this.insideLobbyData, "warning", "There must be a Blue Spymaster before starting the game!")

                    socket.emit("start game", data)
                },

                sendHint(){ // Spymaster sends a hint (1 word)
                    //console.log("Sending hint...")

                    let data = {
                        userId: this.userId,
                        hash: this.sessionHash,
                        roomId: this.roomId,
                        maxGuesses: this.hintNumGuesses,
                        hint: this.hintWord
                    }

                    if(!(this.hintNumGuesses >= 1 && this.hintNumGuesses <= this.roomData.boardHeight * this.roomData.boardWidth)) return setAlertData(this.insideLobbyData, "warning", `The number of guesses must be at least 1 and at most ${this.roomData.boardHeight * this.roomData.boardWidth}.`)
                    if(data.hint.length <= 0 || data.hint.match(/[^a-zA-Z]/)) return setAlertData(this.insideLobbyData, "warning", "Hint must be only one word, containing only letters.")

                    socket.emit("send hint", data)
                },

                sendGuess(e){ // e = MouseEvent, clicked word
                    let row = parseInt(e.target.getAttribute("word-row"))
                    let col = parseInt(e.target.getAttribute("word-col"))
                    let index = (row-1) * this.roomData.boardWidth + col-1
                    let wordId = this.roomData.words[index].id

                    let data = {
                        userId: this.userId,
                        hash: this.sessionHash,
                        roomId: this.roomId,
                        wordId: wordId
                    }

                    socket.emit("send guess", data)
                },

                getAdditionalWordBubbleClass(index, col){ // Index = word index in the array. If 'col' is specified, index becomes the 'row' instead
                    if(col)
                        index = (index-1) * this.roomData.boardWidth + col-1
                    let word = this.roomData.words[index]
                    let revealed = word.revealed
                    let color = word.color
                    let newClass = {}
                    let className = undefined
                    if(color == 'Blue') className = "blueWordBubble"
                    if(color == 'Red') className = "redWordBubble"
                    if(color == 'Gray') className = "grayWordBubble"
                    if(color == 'Black') className = "blackWordBubble"
                    if(className && this.myRole == "spymaster" && revealed == 'true')
                        className += "_dark"

                    if(className)
                        newClass[className] = true
                    if(newClass)
                        console.log(`Got a new class: ${newClass}, color = ${color}`)
                    return newClass
                },

                endTurn(){
                    let data = {
                        userId: this.userId,
                        hash: this.sessionHash,
                        roomId: this.roomId
                    }

                    socket.emit("pass turn", data)
                }
            }
        })
    </script>
</body>